name: Publish Python package
on:
  workflow_call:
    inputs:
      pyproject-toml-dir:
        type: string
        required: false
        description: "The directory where the pyproject.toml file is located, relative to the repository top-level directory."
      pypi-package:
        type: boolean
        required: false
        default: true
        description: "Whether to create the Python wheel and publish it to PyPI"
      conda-package:
        type: boolean
        required: false
        default: true
        description: "Whether to create the Conda package and publish it to Anaconda.org"
      pypi-token:
        type: string
        required: false
        description: "The token used to publish the package to PyPI. Ignored if `pypi-package` is false."
      anaconda-token:
        type: string
        required: false
        description: "The token used to publish the package to Anaconda.org. Ignored if `conda-package` is false."
      anaconda-username:
        type: string
        required: false
        description: "The name of the conda channel where the package will be published to. Ignored if `conda-package` is false."

env:
  PYTHON_ARTIFACT_NAME: _python_artifact
  PYTHON_ARTIFACT_DIR: _artifact_dir
  ARTIFACT_NAME: _dist_artifact
      
jobs:
  inputs_sanity_check:
    runs-on: ubuntu-latest
    outputs:
      pyproject_toml_dir: ${{ steps.check-pyproject-toml-dir.outputs.pyproject_toml_dir }}
      pypi_token: ${{ steps.check-pypi-token.outputs.pypi_token }}
      anaconda_token: ${{ steps.check-anaconda-token.outputs.anaconda_token }}
      anaconda_username: ${{ steps.check-anaconda-username.outputs.anaconda_username }}
    steps:
      - uses: actions/checkout@v5

      - name: Check pyproject.toml directory
        id: check-pyproject-toml-dir
        run: |
          # Set the current repository root as the default pyproject_toml_dir value
          input_pyproject_toml_dir='${{ inputs.pyproject-toml-dir }}'
          pyproject_toml_dir=${input_pyproject_toml_dir:-.}
          # Check that the directory exists
          if [ ! -d "$pyproject_toml_dir" ]; then
            echo "::error Directory '$pyproject_toml_dir' not found in the current repository"
            exit 1
          fi
          # Check that directory contains a pyproject.toml file
          if [ ! -f "$pyproject_toml_dir/pyproject.toml" ]; then
            echo "::error 'pyproject.toml' not found in '${{ inputs.pyproject-toml-dir }}'"
            exit 1
          fi
          echo "pyproject_toml_dir=$pyproject_toml_dir" >> $GITHUB_OUTPUT
          echo "pyproject.toml found in '$pyproject_toml_dir'"
    
      - name: Check PyPI token
        if: ${{ inputs.pypi-package }}
        id: check-pypi-token
        run: |
          # Check that pypi_token is not empty
          if [ -z '${{ inputs.pypi-token || secrets.PYPI_TOKEN }}' ]; then
              echo "::error::pypi-token appears to be empty. Make sure to either:\n- specify a valid 'pypi-token'\n- set a valid PYPI_TOKEN GitHub secret in the calling repo and call this workflow using \`secrets: inherit\`"
              exit 1
          fi
      
      - name: Check Anaconda token
        if: ${{ inputs.conda-package }}
        id: check-anaconda-token
        run: |
          # Check that anaconda_token is not empty
          if [ -z '${{ inputs.anaconda-token || secrets.ANACONDA_TOKEN }}' ]; then
              echo "::error::anaconda-token appears to be empty. Make sure to either:\n- specify a valid 'anaconda-token'\n- set a valid ANACONDA_TOKEN GitHub secret in the calling repo and call this workflow using \`secrets: inherit\`"
              exit 1
          fi
      
      - name: Check Anaconda username
        if: ${{ inputs.conda-package }}
        id: check-anaconda-username
        run: |
          # Check that anaconda_username is not empty
          if [ -z '${{ inputs.anaconda-username || secrets.ANACONDA_USERNAME }}' ]; then
              echo "::error::anaconda-username appears to be empty. Make sure to either:\n- specify a valid 'anaconda-username'\n- set a valid ANACONDA_USERNAME GitHub secret in the calling repo and call this workflow using \`secrets: inherit\`"
              exit 1
          fi

  build_tarball_and_python_wheel:
    name: Build tarball and Python wheel
    runs-on: ubuntu-latest
    needs: inputs_sanity_check
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        
      - name: Install build dependencies
        run: python -m pip install build ${{ inputs.pypi-package == 'true' && 'twine' || '' }}

      - name: Build distributions
        run: |
          pyproject-build '${{ inputs.pypi-package != 'true' && '--sdist' || '' }}' \
            --outdir '${{ env.PYTHON_ARTIFACT_DIR }}'
            --src '${{ needs.inputs_sanity_check.outputs.pyproject_toml_dir }}'

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PYTHON_ARTIFACT_NAME }}
          path: ${{ env.PYTHON_ARTIFACT_DIR }}/*
  
  publish-pypi-package:
    name: Publish package to PyPI
    runs-on: ubuntu-latest
    needs: build_tarball_and_python_wheel
    if: ${{ inputs.pypi-package }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Download artifact
        id: download-artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.PYTHON_ARTIFACT_NAME }}
    
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          password: '${{ inputs.pypi-token || secrets.PYPI_TOKEN }}'
          packages-dir: ${{ env.PYTHON_ARTIFACT_DIR }}

  publish-conda-package:
    name: Publish package to Anaconda.org
    runs-on: ubuntu-latest
    needs: build_tarball_and_python_wheel
    if: ${{ inputs.conda-package }}
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        id: download-artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.PYTHON_ARTIFACT_NAME }}
    
      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: build-env
          create-args: >-
            conda-build
            anaconda-client
            versioneer
            grayskull
      
      - name: Create recipe from tarball
        run: |
          grayskull pypi ${{ env.PYTHON_ARTIFACT_DIR }}/*.tar.gz --output recipe_dir
      
      - name: Publish package to Anaconda.org
        id: publish-conda-package
        uses: ACCESS-NRI/action-build-and-upload-conda-packages@v3.0.0
        with:
          meta_yaml_dir: recipe_dir
          user: '${{ inputs.anaconda-username || secrets.ANACONDA_USERNAME }}'
          token: '${{ inputs.anaconda-token || secrets.ANACONDA_TOKEN }}'

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ steps.publish-conda-package.outputs.paths }}
            ${{ env.PYTHON_ARTIFACT_DIR }}/*
    
      - name: Set output artifact name
        run: echo "artifact-name=${{ env.ARTIFACT_NAME }}" >> $GITHUB_OUTPUT